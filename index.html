<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CJ PriceWatch — Demo Premium</title>
<style>
:root{
  --bg:#f5f6fa;--card:#fff;--ink:#0e0f2b;--muted:#6b7280;--primary:#2a3ef4;
  --ok:#0b8c57;--warn:#b45309;--bad:#b00020;--border:#e5e7eb;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu}
.container{max-width:1240px;margin:0 auto;padding:24px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:750;letter-spacing:-.02em;font-size:clamp(18px,2.6vw,26px)}
.search{display:flex;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:8px 10px;box-shadow:0 1px 2px rgba(0,0,0,.04);min-width:360px;max-width:680px;width:100%}
.search input{flex:1;border:0;outline:none;background:transparent;font-size:16px;padding:8px}
.btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.secondary{background:#111}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
.bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chip{background:#f0f3ff;border:1px solid #d9e0ff;color:#1a2ad6;border-radius:999px;padding:6px 10px;font-size:12px}
.grid{display:grid;gap:12px}
.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:1024px){.cols-4{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.cols-4{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);position:relative}
.k{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.v{font-size:26px;font-weight:800;margin-top:4px}
.badge{position:absolute;top:10px;right:10px;background:#111;color:#fff;font-size:11px;border-radius:999px;padding:4px 8px}
.badge.ok{background:var(--ok)} .badge.warn{background:var(--warn)} .badge.bad{background:var(--bad)}
.table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.table th,.table td{padding:12px}
.table thead{background:#fbfbfc;color:var(--muted)}
.table tr+tr{border-top:1px solid var(--border)}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;align-items:center;gap:10px}
.right{margin-left:auto}
.spark{width:120px;height:26px}
.delta-pos{color:var(--ok);font-weight:700}
.delta-neg{color:var(--bad);font-weight:700}
.footer{margin-top:8px;color:var(--muted);font-size:12px}
.panel{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
@media(max-width:900px){.panel{grid-template-columns:1fr}}
.form-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.form-row label{font-size:12px;color:var(--muted)}
.input{width:120px;padding:8px;border:1px solid var(--border);border-radius:10px}
.hr{height:1px;background:var(--border);margin:8px 0}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.tip{font-size:11px;color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">CJ PriceWatch — Demo Premium</div>
      <div class="bar search">
        <input id="q" placeholder="Medida + marca (ex.: 2055516yok ou 205/55 R16 Yokohama)"/>
        <button class="btn" id="go">Pesquisar</button>
      </div>
      <div class="btns">
        <button class="btn ghost" id="exportCsv">Exportar CSV</button>
        <button class="btn secondary" id="shareWa">Partilhar no WhatsApp</button>
        <button class="btn ghost" id="copySummary">Copiar resumo</button>
      </div>
    </div>

    <div class="bar" id="chips" style="margin-top:8px"></div>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card">
        <div class="k">O meu preço</div>
        <div class="v" id="vMe">—</div>
        <div class="small" id="tMe">—</div>
        <div class="badge" id="bRank">pos</div>
      </div>
      <div class="card">
        <div class="k">Média dos concorrentes</div>
        <div class="v" id="vAvg">—</div>
        <div class="small" id="tAvg">—</div>
      </div>
      <div class="card">
        <div class="k">Diferença média (€)</div>
        <div class="v" id="vDiff">—</div>
        <div class="small">Média concorrentes − meu preço</div>
      </div>
      <div class="card">
        <div class="k">Diferença média (%)</div>
        <div class="v" id="vPct">—</div>
        <div class="small">((média − meu) ÷ média)</div>
      </div>
    </div>

    <div class="bar" style="margin:12px 0">
      <span class="chip" id="cAdv">Vantagem: —</span>
      <span class="chip" id="cAlert">Sem alertas</span>
      <span class="small right" id="lastRun">—</span>
    </div>

    <!-- Painel de Oportunidade -->
    <div class="card panel">
      <div>
        <div class="k">Preço recomendado (simulação local)</div>
        <div class="v" id="recPrice">—</div>
        <div class="small" id="recWhy">—</div>
        <div class="hr"></div>
        <div class="k">Impacto estimado (mês)</div>
        <div class="v" id="impact">—</div>
        <div class="small" id="margins">—</div>
      </div>
      <div>
        <div class="k">Parâmetros (podes editar)</div>
        <div class="form-row">
          <div>
            <label>Volume/mês</label><br/>
            <input id="inpVol" class="input" type="number" step="1" value="120"/>
          </div>
          <div>
            <label>Custo (€/uni)</label><br/>
            <input id="inpCost" class="input" type="number" step="0.01" value="9.50"/>
          </div>
          <div>
            <label>Margem mínima (%)</label><br/>
            <input id="inpMinMargin" class="input" type="number" step="1" value="15"/>
          </div>
        </div>
        <div class="hr"></div>
        <div class="form-row">
          <div>
            <label>Delta “segurança” (abaixo do min concorrente)</label><br/>
            <input id="inpDelta" class="input" type="number" step="0.10" value="0.10"/>
          </div>
          <div>
            <label>Alvo de posição</label><br/>
            <select id="inpTarget" class="input">
              <option value="1">Top‑1 (mais barato)</option>
              <option value="2" selected>Top‑2</option>
              <option value="avg">Abaixo da média</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <button class="btn" id="recalc">Recalcular recomendação</button>
        <div class="tip" style="margin-top:6px">Nota: nunca recomendamos abaixo de custo + margem mínima.</div>
      </div>
    </div>

    <!-- Tabela -->
    <table class="table" style="margin-top:12px">
      <thead>
        <tr>
          <th style="text-align:left">Posição</th>
          <th style="text-align:left">Vendedor</th>
          <th style="text-align:right">Preço</th>
          <th style="text-align:right">Δ vs. meu (€)</th>
          <th style="text-align:right">Δ vs. meu (%)</th>
          <th style="text-align:right">Tendência (3 leituras)</th>
          <th style="text-align:right">Atualizado</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" style="text-align:center;padding:16px">Insira uma pesquisa para ver resultados.</td></tr>
      </tbody>
    </table>

    <div class="footer">
      Demo local (mock). Em produção: dados da API + n8n (48h). O botão “Partilhar no WhatsApp” gera uma mensagem com resumo do SKU (apenas para contactos com opt‑in).
    </div>
  </div>

<script>
const BRAND_MAP = {yok:'Yokohama',cn:'Continental',mb:'Mabor',bs:'Bridgestone',hn:'Hankook',pn:'Pirelli'};
const € = new Intl.NumberFormat('pt-PT',{style:'currency',currency:'EUR'}).format;

function parseInput(s){
  if(!s) return null;
  const raw = String(s).toLowerCase().trim();
  const alnum = raw.replace(/\s+/g,'').replace(/[^a-z0-9]/g,'').replace(/r/,'');
  const width = Number(alnum.slice(0,3));
  const aspect = Number(alnum.slice(3,5));
  const rim = Number(alnum.slice(5,7));
  let brandChunk = alnum.slice(7);
  if(!width||!aspect||!rim||!brandChunk) return null;
  const direct = Object.keys(BRAND_MAP).find(k=>brandChunk.startsWith(k));
  const brandCode = direct || brandChunk;
  const brand = BRAND_MAP[brandCode] || brandCode.toUpperCase();
  return {width,aspect,rim,brand,brandCode};
}

// ===== MOCK de dados (trocar por API real mais tarde) =====
function mockFetch(query){
  const seed = (query.width*1.3 + query.rim*0.77) % 7;
  const me = +(14.50 + seed).toFixed(2);
  const c1 = +(me + 2.80).toFixed(2);
  const c2 = +(me + 5.90).toFixed(2);
  const c3 = +(me + 8.20).toFixed(2);
  const now = new Date();
  const minus = (h)=> new Date(now.getTime()-h*3600*1000);
  function hist(base){ return [base*0.98, base*1.01, base].map(v=>+v.toFixed(2)); }
  return {
    query,
    sources:[
      {name:"Chaveca & Janeira", price:me, ts:minus(1), hist:hist(me), me:true},
      {name:"Concorrente 1", price:c1, ts:minus(6), hist:hist(c1)},
      {name:"Concorrente 2", price:c2, ts:minus(28), hist:hist(c2)},
      {name:"Concorrente 3", price:c3, ts:minus(40), hist:hist(c3)},
    ]
  };
}
// =========================================================

function hoursAgo(d){ return Math.floor((Date.now()-d.getTime())/3600e3); }
function formatTS(d){ const h = hoursAgo(d); return h<=48 ? `${h}h` : `>${h}h`; }

function renderChips(q){
  const chips = document.getElementById('chips'); chips.innerHTML = '';
  [["Largura", q.width],["Perfil", q.aspect],["Jante","R"+q.rim],["Marca", q.brand]].forEach(([k,v])=>{
    const s = document.createElement('span'); s.className='chip'; s.textContent=`${k}: ${v}`; chips.appendChild(s);
  });
}

function sparkline(values){
  const min = Math.min(...values), max = Math.max(...values);
  const w=120, h=26, pad=2;
  const pts = values.map((v,i)=>{
    const x = pad + i*( (w-2*pad)/(values.length-1) );
    const y = h-pad - ((v-min)/(max-min||1))*(h-2*pad);
    return `${x},${y}`;
  }).join(' ');
  return `<svg class="spark" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <polyline fill="none" stroke="#2A3EF4" stroke-width="2" points="${pts}"/>
  </svg>`;
}

// === Recomendação de preço ===
function recommend(mePrice, comps, params){
  const minConc = Math.min(...comps.map(c=>c.price));
  const avgConc = comps.reduce((a,b)=>a+b.price,0)/comps.length;
  let target;
  if(params.target==='1'){ target = Math.max(params.floor, +(minConc - params.delta).toFixed(2)); }
  else if(params.target==='2'){
    const sorted = [...comps].map(c=>c.price).sort((a,b)=>a-b);
    target = Math.max(params.floor, +((sorted[0] + params.delta)).toFixed(2));
  } else { // abaixo da média
    target = Math.max(params.floor, +(avgConc - params.delta).toFixed(2));
  }
  const why = (mePrice <= (minConc - 0.5)) ? 
    `Muito abaixo do mercado. Subir até ${€(minConc - params.delta)} mantém liderança.` :
    (mePrice > avgConc ? `Acima da média. Descer para ${€(avgConc - params.delta)} volta a ser competitivo.` :
     `Preço competitivo. Pequeno ajuste pode optimizar margem.`);
  return {target, why, minConc, avgConc};
}

function exportCSV(rows){
  const headers = ['posicao','vendedor','preco','delta_vs_me_eur','delta_vs_me_pct','atualizado'];
  const csv = [headers.join(',')]
    .concat(rows.map(r=>[r.rank,r.name,r.price.toFixed(2), (r.price-r.mePrice).toFixed(2), (((r.price-r.mePrice)/r.mePrice)*100).toFixed(2)+'%', formatTS(r.ts)].join(',')))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='cj-pricewatch.csv'; a.click();
  URL.revokeObjectURL(url);
}

let current = null;

function recalcPanel(){
  if(!current) return;
  const me = current.sources.find(s=>s.me);
  const comps = current.sources.filter(s=>!s.me);
  const vol = Number(document.getElementById('inpVol').value||0);
  const cost = Number(document.getElementById('inpCost').value||0);
  const minMargin = Number(document.getElementById('inpMinMargin').value||0)/100;
  const delta = Number(document.getElementById('inpDelta').value||0.1);
  const target = document.getElementById('inpTarget').value;

  const floor = +(cost*(1+minMargin)).toFixed(2);
  const rec = recommend(me.price, comps, {delta,target,floor});
  const recPrice = Math.max(rec.target, floor);

  const diffUnit = recPrice - me.price;
  const impact = diffUnit * vol;
  const marginNow = me.price - cost;
  const marginNew = recPrice - cost;
  document.getElementById('recPrice').textContent = €(recPrice);
  document.getElementById('recWhy').textContent = rec.why;
  document.getElementById('impact').textContent = (impact>=0?'+':'') + €(impact);
  document.getElementById('margins').textContent = `Margem atual: ${€(marginNow)} (${((marginNow/Math.max(me.price,0.01))*100).toFixed(1)}%), ` +
    `Com recomendado: ${€(marginNew)} (${((marginNew/Math.max(recPrice,0.01))*100).toFixed(1)}%)`;
}

function buildSummaryText(data){
  const me = data.sources.find(s=>s.me);
  const comps = data.sources.filter(s=>!s.me);
  const avg = comps.reduce((a,b)=>a+b.price,0)/comps.length;
  const diffVal = avg - me.price;
  const diffPct = (diffVal/avg)*100;
  const ranked = [...data.sources].sort((a,b)=>a.price-b.price);
  const top = ranked[0];
  const q = data.query;
  const title = `CJ PriceWatch — ${q.width}/${q.aspect} R${q.rim} ${q.brand}`;
  const line1 = `Meu: ${€(me.price)} | Média concorrentes: ${€(avg)} | Dif: ${(diffPct>=0?'+':'')+diffPct.toFixed(1)}% (${€(diffVal)})`;
  const line2 = `Mais barato: ${top.name} a ${€(top.price)} | Posição atual: ${ranked.findIndex(s=>s.me)+1}º`;
  return `${title}\n${line1}\n${line2}\n(Atualizado há ${formatTS(me.ts)}; partilhado via CJ PriceWatch)`;
}

function shareWhatsApp(){
  if(!current){ alert('Faz primeiro uma pesquisa.'); return; }
  const text = encodeURIComponent(buildSummaryText(current));
  const url = "https://wa.me/?text=" + text;
  window.open(url, "_blank");
}

async function search(){
  const q = parseInput(document.getElementById('q').value);
  if(!q){ alert('Ex.: 2055516yok ou 205/55 R16 Yokohama'); return; }
  const data = mockFetch(q);
  current = data;
  renderChips(q);

  const me = data.sources.find(s=>s.me), comps = data.sources.filter(s=>!s.me);
  const avg = comps.reduce((a,b)=>a+b.price,0)/comps.length;
  const diffVal = avg - me.price;
  const diffPct = (diffVal/avg)||0;

  // Ranking
  const ranked = [...data.sources].sort((a,b)=>a.price-b.price).map((s,i)=>({...s,rank:i+1}));
  const myRank = ranked.find(s=>s.me).rank;

  // Summary cards
  document.getElementById('vMe').textContent = €(me.price);
  const rankBadge = document.getElementById('bRank');
  rankBadge.textContent = `${myRank}º`;
  rankBadge.className = 'badge ' + (myRank===1?'ok':(myRank===2?'warn':'bad'));
  document.getElementById('tMe').textContent = `Atualizado há ${formatTS(me.ts)}`;

  document.getElementById('vAvg').textContent = €(avg);
  document.getElementById('tAvg').textContent = `Concorrentes: ${comps.length}`;
  document.getElementById('vDiff').textContent = €(diffVal);
  document.getElementById('vPct').textContent = (diffPct*100).toFixed(2)+'%';
  document.getElementById('lastRun').textContent = 'Última consulta: agora';

  // Advantage chip
  const cAdv = document.getElementById('cAdv');
  const advPct = ((avg - me.price)/avg)*100;
  cAdv.textContent = advPct>=0 ? `Vantagem vs. média: ${advPct.toFixed(1)}%` : `Acima da média: ${(-advPct).toFixed(1)}%`;

  // Alerts
  const cAlert = document.getElementById('cAlert');
  const cuts = comps.filter(s=> s.hist[2] < s.hist[1]*0.95 );
  cAlert.textContent = cuts.length? `Alerta: ${cuts.length} concorrente(s) baixou ≥5%` : 'Sem alertas';

  // Table rows
  const tbody = document.getElementById('tbody');
  tbody.innerHTML='';
  ranked.forEach(s=>{
    const delta = s.price - me.price;
    const deltaPct = (delta/(me.price||1))*100;
    const tr = document.createElement('tr');
    const cls = delta<0?'delta-neg':(delta>0?'delta-pos':'');
    tr.innerHTML = `<td>${s.rank}º</td>
      <td>${s.me?'<strong>Chaveca & Janeira</strong>':s.name}</td>
      <td style="text-align:right">${€(s.price)}</td>
      <td style="text-align:right" class="${cls}">${delta===0?'—':€(delta)}</td>
      <td style="text-align:right" class="${cls}">${delta===0?'—':(deltaPct>0?'+':'')+deltaPct.toFixed(1)+'%'}</td>
      <td style="text-align:right">${sparkline(s.hist)}</td>
      <td style="text-align:right" class="small">${formatTS(s.ts)}</td>`;
    tbody.appendChild(tr);
  });

  // Recalc panel with current params
  recalcPanel();
}

function copySummary(){
  if(!current){ alert('Faz primeiro uma pesquisa.'); return; }
  const text = buildSummaryText(current);
  navigator.clipboard.writeText(text).then(()=>{
    alert("Resumo copiado para a área de transferência.");
  });
}

document.getElementById('go').addEventListener('click', search);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(); });
document.getElementById('recalc').addEventListener('click', recalcPanel);
document.getElementById('exportCsv').addEventListener('click', ()=>{
  if(!current){ alert('Faz primeiro uma pesquisa.'); return; }
  const me = current.sources.find(s=>s.me);
  const rows = [...current.sources].sort((a,b)=>a.price-b.price).map(s=>({rank:0,name:s.name,price:s.price,ts:s.ts,mePrice:me.price}));
  rows.forEach((r,i)=>r.rank=i+1);
  exportCSV(rows);
});
document.getElementById('shareWa').addEventListener('click', shareWhatsApp);
document.getElementById('copySummary').addEventListener('click', copySummary);
</script>
</body>
</html>
