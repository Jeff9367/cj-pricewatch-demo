<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CJ PriceWatch — Demo Premium</title>
<style>
:root{--bg:#f5f6fa;--card:#fff;--ink:#0e0f2b;--muted:#6b7280;--primary:#2a3ef4;--ok:#0b8c57;--warn:#b45309;--bad:#b00020;--border:#e5e7eb;}
*{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu}
.container{max-width:1240px;margin:0 auto;padding:24px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:750;letter-spacing:-.02em;font-size:clamp(18px,2.6vw,26px)}
.search{display:flex;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:8px 10px;min-width:360px;max-width:680px;width:100%;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.search input{flex:1;border:0;outline:none;background:transparent;font-size:16px;padding:8px}
.btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
.bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chip{background:#f0f3ff;border:1px solid #d9e0ff;color:#1a2ad6;border-radius:999px;padding:6px 10px;font-size:12px}
.grid{display:grid;gap:12px}
.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:1024px){.cols-4{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.cols-4{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);position:relative}
.k{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.v{font-size:26px;font-weight:800;margin-top:4px}
.badge{position:absolute;top:10px;right:10px;background:#111;color:#fff;font-size:11px;border-radius:999px;padding:4px 8px}
.badge.ok{background:var(--ok)} .badge.warn{background:var(--warn)} .badge.bad{background:var(--bad)}
.table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.table th,.table td{padding:12px}
.table thead{background:#fbfbfc;color:var(--muted)}
.table tr+tr{border-top:1px solid var(--border)}
.small{font-size:12px;color:var(--muted)}
.spark{width:120px;height:26px}
.delta-pos{color:var(--ok);font-weight:700}
.delta-neg{color:var(--bad);font-weight:700}
.footer{margin-top:8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">CJ PriceWatch — Demo Premium</div>
      <form class="search" onsubmit="triggerSearch();return false;">
        <input id="q" autocomplete="off" placeholder="Medida + marca (ex.: 2055516yok ou 205/55 R16 Yokohama)"/>
        <button type="button" class="btn" id="go" onclick="triggerSearch()">Pesquisar</button>
      </form>
    </div>

    <div class="bar" id="chips" style="margin-top:8px"></div>

    <div class="grid cols-4" style="margin-top:12px">
      <div class="card"><div class="k">O meu preço</div><div class="v" id="vMe">—</div><div class="small" id="tMe">—</div><div class="badge" id="bRank">pos</div></div>
      <div class="card"><div class="k">Média dos concorrentes</div><div class="v" id="vAvg">—</div><div class="small" id="tAvg">—</div></div>
      <div class="card"><div class="k">Diferença média (€)</div><div class="v" id="vDiff">—</div><div class="small">Média concorrentes − meu preço</div></div>
      <div class="card"><div class="k">Diferença média (%)</div><div class="v" id="vPct">—</div><div class="small">((média − meu) ÷ média)</div></div>
    </div>

    <table class="table" style="margin-top:12px">
      <thead>
        <tr>
          <th style="text-align:left">Posição</th>
          <th style="text-align:left">Vendedor</th>
          <th style="text-align:right">Preço</th>
          <th style="text-align:right">Δ vs. meu (€)</th>
          <th style="text-align:right">Δ vs. meu (%)</th>
          <th style="text-align:right">Tendência (3 leituras)</th>
          <th style="text-align:right">Atualizado</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" style="text-align:center;padding:16px">Insira uma pesquisa para ver resultados.</td></tr>
      </tbody>
    </table>

    <div class="footer">Demo com dados fictícios. Exemplo: <b>2055516yok</b>. Se nada acontecer, recarregue com <b>Ctrl+F5</b>.</div>
  </div>

<script>
"use strict";
const BRAND_MAP = {yok:'Yokohama',cn:'Continental',mb:'Mabor',bs:'Bridgestone',hn:'Hankook',pn:'Pirelli'};
const F = new Intl.NumberFormat('pt-PT',{style:'currency',currency:'EUR'});

function parseInput(s){
  if(!s) return null;
  const raw = String(s).toLowerCase().trim();
  const alnum = raw.replace(/\s+/g,'').replace(/[^a-z0-9]/g,'').replace(/r/,'');
  const width = Number(alnum.slice(0,3));
  const aspect = Number(alnum.slice(3,5));
  const rim = Number(alnum.slice(5,7));
  const brandChunk = alnum.slice(7);
  if(!width||!aspect||!rim||!brandChunk) return null;
  const code = Object.keys(BRAND_MAP).find(k=>brandChunk.startsWith(k)) || brandChunk;
  return {width,aspect,rim,brand:(BRAND_MAP[code]||code.toUpperCase())};
}

function mockFetch(q){
  const seed = (q.width*1.3 + q.rim*0.77) % 7;
  const me = +(14.50 + seed).toFixed(2);
  const c1 = +(me + 2.80).toFixed(2);
  const c2 = +(me + 5.90).toFixed(2);
  const c3 = +(me + 8.20).toFixed(2);
  const now = new Date();
  const h = v => [+(v*0.98).toFixed(2), +(v*1.01).toFixed(2), v];
  return {
    query:q,
    sources:[
      {name:"Chaveca & Janeira", price:me, ts:new Date(now-1*3600e3),  hist:h(me), me:true},
      {name:"Concorrente 1",     price:c1, ts:new Date(now-6*3600e3),  hist:h(c1)},
      {name:"Concorrente 2",     price:c2, ts:new Date(now-28*3600e3), hist:h(c2)},
      {name:"Concorrente 3",     price:c3, ts:new Date(now-40*3600e3), hist:h(c3)}
    ]
  };
}

function hoursAgo(d){ return Math.floor((Date.now()-d.getTime())/3600e3); }
function ts(d){ const h=hoursAgo(d); return h<=48?`${h}h`:`>${h}h`; }
function spark(values){
  const min = Math.min(...values), max = Math.max(...values);
  const w=120, h=26, pad=2;
  const pts = values.map((v,i)=>{
    const x = pad + i*((w-2*pad)/(values.length-1));
    const y = h-pad - ((v-min)/(max-min||1))*(h-2*pad);
    return `${x},${y}`;
  }).join(' ');
  return `<svg class="spark" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
            <polyline fill="none" stroke="#2A3EF4" stroke-width="2" points="${pts}"/>
          </svg>`;
}

function renderBoard(q){
  const data = mockFetch(q);
  const me = data.sources.find(s=>s.me), comps = data.sources.filter(s=>!s.me);
  const avg = comps.reduce((a,b)=>a+b.price,0)/comps.length;
  const diff = avg - me.price, diffPct = diff/avg;

  const chips = document.getElementById('chips');
  chips.innerHTML = '';
  [['Largura',q.width],['Perfil',q.aspect],['Jante','R'+q.rim],['Marca',q.brand]].forEach(([k,v])=>{
    const el = document.createElement('span'); el.className='chip'; el.textContent=`${k}: ${v}`; chips.appendChild(el);
  });

  document.getElementById('vMe').textContent = F.format(me.price);
  document.getElementById('tMe').textContent = 'Atualizado há ' + ts(me.ts);

  const ranked = [...data.sources].sort((a,b)=>a.price-b.price);
  const myRank = ranked.findIndex(s=>s.me)+1;
  const b = document.getElementById('bRank');
  b.textContent = myRank+'º'; b.className = 'badge ' + (myRank===1?'ok':(myRank===2?'warn':'bad'));

  document.getElementById('vAvg').textContent = F.format(avg);
  document.getElementById('tAvg').textContent = 'Concorrentes: '+comps.length;
  document.getElementById('vDiff').textContent = F.format(diff);
  document.getElementById('vPct').textContent = (diffPct*100).toFixed(2)+'%';

  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  ranked.forEach((s,i)=>{
    const delta = s.price - me.price, deltaPct = (delta/(me.price||1))*100;
    const cls = delta<0?'delta-neg':(delta>0?'delta-pos':'');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}º</td>
      <td>${s.me?'<strong>Chaveca & Janeira</strong>':s.name}</td>
      <td style="text-align:right">${F.format(s.price)}</td>
      <td style="text-align:right" class="${cls}">${delta===0?'—':F.format(delta)}</td>
      <td style="text-align:right" class="${cls}">${delta===0?'—':(deltaPct>0?'+':'')+deltaPct.toFixed(1)+'%'}</td>
      <td style="text-align:right">${spark(s.hist)}</td>
      <td style="text-align:right" class="small">${ts(s.ts)}</td>`;
    tbody.appendChild(tr);
  });
}

function triggerSearch(){
  const inp = document.getElementById('q');
  const q = parseInput(inp.value);
  if(!q){ alert('Ex.: 2055516yok ou 205/55 R16 Yokohama'); inp.focus(); return; }
  renderBoard(q);
}

// fallback total: garantir binding mesmo que o browser atrase scripts
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('go').addEventListener('click', triggerSearch);
  document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); triggerSearch(); } });
  // auto-demo para provar que está tudo a funcionar
  const inp = document.getElementById('q'); inp.value = '2055516yok'; triggerSearch();
});
</script>
</body>
</html>
